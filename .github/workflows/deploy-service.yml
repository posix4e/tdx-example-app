# Deploy persistent TDX VM running the service
# VM continues running after workflow completes
# Uses 9P filesystem sharing - no SSH required

name: Deploy Service

on:
  workflow_dispatch:
    inputs:
      vm_name:
        description: 'Name for the VM'
        required: true
        default: 'example-app'
      memory_gb:
        description: 'Memory in GB'
        required: true
        default: '8'
      cpus:
        description: 'Number of CPUs'
        required: true
        default: '4'
      service_url:
        description: 'Public URL for this service (for discovery registration)'
        required: false
        default: 'https://example.easyenclave.com'

jobs:
  deploy:
    runs-on: [self-hosted, tdx]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create environment file
        run: |
          cat > .env << EOF
          SERVICE_URL=${{ github.event.inputs.service_url }}
          EASYENCLAVE_URL=https://app.easyenclave.com
          GIT_COMMIT=${{ github.sha }}
          EOF
          cat .env

      - name: Download EasyEnclave SDK
        run: |
          # Download the SDK from the easyenclave repo
          curl -sL https://github.com/easyenclave/easyenclave/archive/refs/heads/main.tar.gz | tar xz
          mv easyenclave-main/sdk easyenclave-sdk
          rm -rf easyenclave-main
          ls -la easyenclave-sdk/

      - name: Deploy to TDX VM
        id: deploy
        uses: posix4e/tdx_github_runner/.github/actions/launch-tdx@main
        with:
          vm_name: ${{ github.event.inputs.vm_name }}
          docker_compose_path: './docker-compose.yml'
          intel_api_key: ${{ secrets.INTEL_API_KEY }}
          vm_memory_gb: ${{ github.event.inputs.memory_gb }}
          vm_cpus: ${{ github.event.inputs.cpus }}
          compose_up_args: '--build -d'
          timeout_minutes: '10'

      - name: Display deployment info
        run: |
          echo ""
          echo "========================================="
          echo "TDX Service Deployed"
          echo "========================================="
          echo ""
          echo "VM Name:        ${{ steps.deploy.outputs.vm_name }}"
          echo "Share Dir:      ${{ steps.deploy.outputs.share_dir }}"
          echo ""
          echo "The service is running inside a TDX Trust Domain."
          echo "Docker compose has been executed with the Intel API key."
          echo ""
          echo "========================================="
          echo "The VM will continue running until explicitly deleted."
          echo "To delete: virsh destroy ${{ steps.deploy.outputs.vm_name }}"
          echo "========================================="

      - name: Save deployment info
        run: |
          mkdir -p deployment-info
          cat > deployment-info/deployment.json << EOF
          {
            "vm_name": "${{ steps.deploy.outputs.vm_name }}",
            "share_dir": "${{ steps.deploy.outputs.share_dir }}",
            "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "github_run_id": "${{ github.run_id }}",
            "github_sha": "${{ github.sha }}"
          }
          EOF

          cat deployment-info/deployment.json

      - name: Register with EasyEnclave Discovery
        if: ${{ github.event.inputs.service_url != '' }}
        run: |
          # Read attestation data if available from share dir
          SHARE_DIR="${{ steps.deploy.outputs.share_dir }}"
          ATTESTATION_FILE="$SHARE_DIR/attestation.json"

          # Build registration payload
          PAYLOAD=$(cat << EOF
          {
            "name": "tdx-example-app",
            "description": "Example TDX-attested application",
            "endpoints": {"prod": "${{ github.event.inputs.service_url }}"},
            "source_repo": "https://github.com/easyenclave/tdx-example-app",
            "source_commit": "${{ github.sha }}",
            "tags": ["example", "tdx", "demo"]
          }
          EOF
          )

          # Add attestation data if available
          if [ -f "$ATTESTATION_FILE" ]; then
            MRTD=$(jq -r '.mrtd // empty' "$ATTESTATION_FILE" 2>/dev/null || true)
            if [ -n "$MRTD" ]; then
              PAYLOAD=$(echo "$PAYLOAD" | jq --arg mrtd "$MRTD" '. + {mrtd: $mrtd}')
            fi
          fi

          echo "Registering with EasyEnclave discovery..."
          echo "Payload: $PAYLOAD"

          RESPONSE=$(curl -s -X POST https://app.easyenclave.com/api/v1/register \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          echo "Response: $RESPONSE"

          SERVICE_ID=$(echo "$RESPONSE" | jq -r '.service_id // empty')
          if [ -n "$SERVICE_ID" ]; then
            echo "Successfully registered with service ID: $SERVICE_ID"
          else
            echo "Warning: Registration may have failed"
          fi

      - name: Upload deployment info
        uses: actions/upload-artifact@v4
        with:
          name: deployment-info-${{ github.event.inputs.vm_name }}
          path: deployment-info/
          retention-days: 30
