# Build in ephemeral TDX VM with attestation
# Attestation is handled at VM level by the launcher
name: Measure Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  measure-build:
    runs-on: [self-hosted, tdx]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download EasyEnclave SDK
        run: |
          curl -sL https://github.com/easyenclave/easyenclave/archive/refs/heads/main.tar.gz | tar xz
          mv easyenclave-main/sdk easyenclave-sdk
          rm -rf easyenclave-main
          ls -la easyenclave-sdk/

      - name: Build and run in TDX VM
        id: measure
        uses: easyenclave/easyenclave/.github/actions/measure-tdx@main
        with:
          intel_api_key: ${{ secrets.INTEL_API_KEY }}
          docker_compose_path: ./docker-compose.yml
          timeout_minutes: '10'
          compose_up_args: '--build -d'
          health_endpoint: '/health'

      - name: Display results
        run: |
          echo ""
          echo "========================================="
          echo "TDX Build Complete"
          echo "========================================="
          echo "VM: ${{ steps.measure.outputs.vm_name }}"
          echo ""
          echo "Attestation (VM-level):"
          echo '${{ steps.measure.outputs.attestation_json }}' | jq . 2>/dev/null || echo "No attestation"
          echo "========================================="
