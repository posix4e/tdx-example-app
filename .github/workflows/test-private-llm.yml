name: Test Private LLM

on:
  workflow_dispatch:
    inputs:
      service_name:
        description: 'Service name for registration'
        default: 'private-llm-test'
      service_url:
        description: 'Service URL (use VM IP after deploy)'
        default: 'http://localhost:8080'

jobs:
  deploy:
    name: Deploy Private LLM in TDX
    runs-on: [self-hosted, tdx]
    outputs:
      vm_name: ${{ steps.deploy.outputs.vm_name }}
      noise_pubkey: ${{ steps.get_pubkey.outputs.noise_pubkey }}
      share_dir: ${{ steps.deploy.outputs.share_dir }}
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to TDX
        id: deploy
        run: |
          # Use tdx_cli from the runner repo
          CLI_PATH="/home/ubuntu/src/tdx_github_runner/infra/tdx_cli.py"

          RESULT=$(python3 "$CLI_PATH" deploy \
            --service-name "${{ github.event.inputs.service_name }}" \
            --service-url "${{ github.event.inputs.service_url }}" \
            --compose "${{ github.workspace }}/examples/private-llm/docker-compose.yml" \
            --intel-api-key "${{ secrets.INTEL_API_KEY }}" \
            --health-endpoint "/health")

          echo "Deploy result:"
          echo "$RESULT" | jq .

          echo "vm_name=$(echo "$RESULT" | jq -r '.vm_name')" >> $GITHUB_OUTPUT
          echo "share_dir=$(echo "$RESULT" | jq -r '.share_dir')" >> $GITHUB_OUTPUT
          echo "mrtd=$(echo "$RESULT" | jq -r '.mrtd')" >> $GITHUB_OUTPUT

      - name: Wait for Noise server
        run: |
          echo "Waiting for proxy to be ready..."
          sleep 30

          # Get VM IP (check share dir for any IP info, or use virsh)
          VM_NAME="${{ steps.deploy.outputs.vm_name }}"
          VM_IP=$(virsh domifaddr "$VM_NAME" 2>/dev/null | grep -oE '192\.[0-9]+\.[0-9]+\.[0-9]+' | head -1 || echo "")

          if [ -z "$VM_IP" ]; then
            echo "Could not get VM IP, trying localhost..."
            VM_IP="localhost"
          fi

          echo "VM IP: $VM_IP"
          echo "vm_ip=$VM_IP" >> $GITHUB_OUTPUT

      - name: Get Noise public key
        id: get_pubkey
        run: |
          VM_NAME="${{ steps.deploy.outputs.vm_name }}"
          VM_IP=$(virsh domifaddr "$VM_NAME" 2>/dev/null | grep -oE '192\.[0-9]+\.[0-9]+\.[0-9]+' | head -1 || echo "localhost")

          # Try to get the noise pubkey from the health endpoint
          for i in {1..10}; do
            HEALTH=$(curl -s "http://${VM_IP}:8080/health" 2>/dev/null || echo "{}")
            PUBKEY=$(echo "$HEALTH" | jq -r '.noise_pubkey // empty')
            if [ -n "$PUBKEY" ]; then
              echo "Got Noise pubkey: ${PUBKEY:0:32}..."
              echo "noise_pubkey=$PUBKEY" >> $GITHUB_OUTPUT
              echo "vm_ip=$VM_IP" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "Waiting for Noise server... (attempt $i)"
            sleep 10
          done

          echo "::error::Could not get Noise public key"
          exit 1

  test-client:
    name: Test Verified Client
    runs-on: [self-hosted, tdx]
    needs: deploy
    steps:
      - uses: actions/checkout@v4

      - name: Install client dependencies
        run: |
          pip install -r examples/private-llm/client/requirements.txt

      - name: Test E2E encrypted connection
        run: |
          cd examples/private-llm

          VM_IP="${{ needs.deploy.outputs.vm_ip }}"
          NOISE_PUBKEY="${{ needs.deploy.outputs.noise_pubkey }}"

          echo "Testing connection to ws://${VM_IP}:8080"
          echo "Noise pubkey: ${NOISE_PUBKEY:0:32}..."

          python client/verified_llm.py "ws://${VM_IP}:8080" "$NOISE_PUBKEY"

  cleanup:
    name: Cleanup
    runs-on: [self-hosted, tdx]
    needs: [deploy, test-client]
    if: always()
    steps:
      - name: Delete TDX VM
        run: |
          VM_NAME="${{ needs.deploy.outputs.vm_name }}"
          if [ -n "$VM_NAME" ]; then
            echo "Cleaning up VM: $VM_NAME"
            virsh destroy "$VM_NAME" 2>/dev/null || true
            virsh undefine "$VM_NAME" 2>/dev/null || true
          fi
